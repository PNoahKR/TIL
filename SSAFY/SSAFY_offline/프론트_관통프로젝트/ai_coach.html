<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>냠냠코치 - AI코치</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">💪 냠냠코치</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">대시보드</a></li>
                    <li class="nav-item"><a class="nav-link" href="meal_log.html">식단기록</a></li>
                    <li class="nav-item"><a class="nav-link" href="challenge.html">챌린지</a></li>
                    <li class="nav-item"><a class="nav-link" href="community.html">커뮤니티</a></li>
                    <li class="nav-item"><a class="nav-link active" href="ai_coach.html">AI코치</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> 마이페이지
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">프로필 수정</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html">로그아웃</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 70px;">
        <div class="text-center mb-5">
            <h1 class="h2">AI 건강 코치</h1>
            <p class="lead text-muted">나의 건강 데이터를 기반으로 맞춤형 조언을 받아보세요.</p>
            <button id="get-advice-btn" class="btn btn-primary btn-lg">AI 코치에게 조언받기 <i class="fas fa-robot"></i></button>
        </div>

        <div id="advice-section" class="d-none">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">AI 코치의 분석 결과</h4>
                </div>
                <div class="card-body" id="advice-content">
                    <!-- AI 조언이 여기에 표시됩니다. -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white text-center p-4 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2025 YumYumCoach. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dataManager.js"></script>
    <script>
        document.getElementById('get-advice-btn').addEventListener('click', async function() {
            const adviceContent = document.getElementById('advice-content');
            const adviceSection = document.getElementById('advice-section');
            
            const user = getLoggedInUser();
            const userData = getUserData();

            if (!user || !userData) {
                alert("로그인 정보가 유효하지 않습니다. 다시 로그인해주세요.");
                window.location.href = 'login.html';
                return;
            }

            adviceContent.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div><p class=\'mt-2\'>AI 코치가 데이터를 분석하고 있습니다...</p></div>';
            adviceSection.classList.remove('d-none');

            try {
                // 데이터 로드
                const statsResponse = await fetch('./data/yumyum_coach_stats.json');
                const stats = await statsResponse.json();

                // 분석 함수 호출
                const bmiAdvice = analyzeBMI(user, stats);
                const calorieAdvice = analyzeCalories(userData, stats, user);
                const varietyAdvice = analyzeDietVariety(userData);

                // 결과 표시
                adviceContent.innerHTML = `
                    ${bmiAdvice}
                    ${calorieAdvice}
                    ${varietyAdvice}
                `;

            } catch (error) {
                console.error("AI 코치 조언 생성 중 오류 발생:", error);
                adviceContent.innerHTML = '<div class="alert alert-danger">조언을 생성하는 데 실패했습니다. 나중에 다시 시도해주세요.</div>';
            }
        });

        // BMI 분석 함수
        function analyzeBMI(user, stats) {
            if (!user.height || !user.weight) {
                return '<div class="alert alert-warning">프로필에 키와 몸무게를 입력하면 더 정확한 BMI 분석을 받을 수 있습니다.</div>';
            }
            const heightM = user.height / 100;
            const bmi = (user.weight / (heightM * heightM)).toFixed(1);
            let result, message;

            if (bmi < 18.5) {
                result = '저체중';
                message = '조금 더 균형 잡힌 식단으로 체중을 늘리는 것을 고려해보세요.';
            } else if (bmi < 23) {
                result = '정상';
                message = '현재 체중을 잘 유지하고 계십니다! 꾸준히 건강을 관리해주세요.';
            } else if (bmi < 25) {
                result = '과체중';
                message = '식단 조절과 꾸준한 운동을 통해 체중 관리를 시작하는 것이 좋습니다.';
            } else {
                result = '비만';
                message = '건강을 위해 전문가와 상담하여 체계적인 체중 감량 계획을 세우는 것을 추천합니다.';
            }

            return `
                <div class="p-3 mb-3 bg-light rounded">
                    <h5><i class="fas fa-balance-scale-right me-2"></i>BMI 분석</h5>
                    <p>회원님의 BMI 지수는 <strong>${bmi}</strong>로, <strong>${result}</strong> 범위에 속합니다.</p>
                    <p class="mb-0"><em>${message}</em></p>
                </div>`;
        }

        // 칼로리 분석 함수
        function analyzeCalories(userData, stats, user) {
            if (userData.meals.length < 3) {
                return '<div class="alert alert-info">식단 기록이 3개 이상 쌓이면 더 정확한 칼로리 분석을 받을 수 있습니다.</div>';
            }
            
            let totalCalories = 0;
            userData.meals.forEach(meal => meal.foods.forEach(food => totalCalories += food.calories));
            const avgCalories = Math.round(totalCalories / userData.meals.length);

            if (!user.age) {
                return '<div class="alert alert-warning">프로필에 나이를 입력하면 더 정확한 칼로리 분석을 받을 수 있습니다.</div>';
            }
            const age = parseInt(user.age);
            let ageGroup = '19-29';
            if (age >= 30 && age <=39) ageGroup = '30-39';
            else if (age >= 40 && age <=49) ageGroup = '40-49';
            else if (age >= 50 && age <=59) ageGroup = '50-59';
            else if (age >= 60 && age <=69) ageGroup = '60-69';
            else if (age >= 70) ageGroup = '70+';

            const peerAvgCalories = stats.averageIntake.byAgeAndGender[ageGroup].total;
            let message;

            if (avgCalories > peerAvgCalories * 1.1) {
                message = `현재 평균 섭취 칼로리는 약 <strong>${avgCalories}kcal</strong>로, 연령대 평균(${peerAvgCalories}kcal)보다 다소 높은 편입니다. 칼로리가 낮은 음식 위주로 식단을 구성해보세요.`;
            } else if (avgCalories < peerAvgCalories * 0.9) {
                message = `현재 평균 섭취 칼로리는 약 <strong>${avgCalories}kcal</strong>로, 연령대 평균(${peerAvgCalories}kcal)보다 낮은 편입니다. 충분한 에너지를 위해 섭취량을 조금 늘리는 것을 고려해보세요.`;
            } else {
                message = `현재 평균 섭취 칼로리는 약 <strong>${avgCalories}kcal</strong>로, 연령대 평균(${peerAvgCalories}kcal)과 비슷한 수준으로 잘 관리하고 계십니다.`;
            }

            return `
                <div class="p-3 mb-3 bg-light rounded">
                    <h5><i class="fas fa-fire-alt me-2"></i>칼로리 섭취 분석</h5>
                    <p>${message}</p>
                </div>`;
        }

        // 식단 다양성 분석 함수
        function analyzeDietVariety(userData) {
            const foodCounter = {};
            let totalFoods = 0;
            userData.meals.forEach(meal => {
                meal.foods.forEach(food => {
                    foodCounter[food.name] = (foodCounter[food.name] || 0) + 1;
                    totalFoods++;
                });
            });

            const uniqueFoods = Object.keys(foodCounter).length;
            let message;

            if (totalFoods < 10) {
                return ''; // 데이터가 부족하면 분석 생략
            }

            if (uniqueFoods / totalFoods < 0.5) {
                message = '최근 식단이 다소 단조로운 경향이 있습니다. 다양한 종류의 음식을 섭취하여 균형 잡힌 영양을 챙겨보세요.';
            } else {
                message = '다양한 종류의 음식을 섭취하며 식단을 잘 관리하고 계십니다. 좋은 습관입니다!';
            }

            return `
                <div class="p-3 bg-light rounded">
                    <h5><i class="fas fa-seedling me-2"></i>식단 다양성 분석</h5>
                    <p>${message}</p>
                </div>`;
        }

    </script>
</body>
</html>