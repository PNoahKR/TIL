<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëƒ ëƒ ì½”ì¹˜ - AIì½”ì¹˜</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">ğŸ’ª ëƒ ëƒ ì½”ì¹˜</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
                    <li class="nav-item"><a class="nav-link" href="meal_log.html">ì‹ë‹¨ê¸°ë¡</a></li>
                    <li class="nav-item"><a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a></li>
                    <li class="nav-item"><a class="nav-link" href="community.html">ì»¤ë®¤ë‹ˆí‹°</a></li>
                    <li class="nav-item"><a class="nav-link active" href="ai_coach.html">AIì½”ì¹˜</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> ë§ˆì´í˜ì´ì§€
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">í”„ë¡œí•„ ìˆ˜ì •</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html">ë¡œê·¸ì•„ì›ƒ</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 70px;">
        <div class="text-center mb-5">
            <h1 class="h2">AI ê±´ê°• ì½”ì¹˜</h1>
            <p class="lead text-muted">ë‚˜ì˜ ê±´ê°• ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• ì¡°ì–¸ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
            <button id="get-advice-btn" class="btn btn-primary btn-lg">AI ì½”ì¹˜ì—ê²Œ ì¡°ì–¸ë°›ê¸° <i class="fas fa-robot"></i></button>
        </div>

        <div id="advice-section" class="d-none">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">AI ì½”ì¹˜ì˜ ë¶„ì„ ê²°ê³¼</h4>
                </div>
                <div class="card-body" id="advice-content">
                    <!-- AI ì¡°ì–¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white text-center p-4 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2025 YumYumCoach. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dataManager.js"></script>
    <script>
        document.getElementById('get-advice-btn').addEventListener('click', async function() {
            const adviceContent = document.getElementById('advice-content');
            const adviceSection = document.getElementById('advice-section');
            
            const user = getLoggedInUser();
            const userData = getUserData();

            if (!user || !userData) {
                alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                window.location.href = 'login.html';
                return;
            }

            adviceContent.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div><p class=\'mt-2\'>AI ì½”ì¹˜ê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p></div>';
            adviceSection.classList.remove('d-none');

            try {
                // ë°ì´í„° ë¡œë“œ
                const statsResponse = await fetch('./data/yumyum_coach_stats.json');
                const stats = await statsResponse.json();

                // ë¶„ì„ í•¨ìˆ˜ í˜¸ì¶œ
                const bmiAdvice = analyzeBMI(user, stats);
                const calorieAdvice = analyzeCalories(userData, stats, user);
                const varietyAdvice = analyzeDietVariety(userData);

                // ê²°ê³¼ í‘œì‹œ
                adviceContent.innerHTML = `
                    ${bmiAdvice}
                    ${calorieAdvice}
                    ${varietyAdvice}
                `;

            } catch (error) {
                console.error("AI ì½”ì¹˜ ì¡°ì–¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                adviceContent.innerHTML = '<div class="alert alert-danger">ì¡°ì–¸ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            }
        });

        // BMI ë¶„ì„ í•¨ìˆ˜
        function analyzeBMI(user, stats) {
            if (!user.height || !user.weight) {
                return '<div class="alert alert-warning">í”„ë¡œí•„ì— í‚¤ì™€ ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ BMI ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
            }
            const heightM = user.height / 100;
            const bmi = (user.weight / (heightM * heightM)).toFixed(1);
            let result, message;

            if (bmi < 18.5) {
                result = 'ì €ì²´ì¤‘';
                message = 'ì¡°ê¸ˆ ë” ê· í˜• ì¡íŒ ì‹ë‹¨ìœ¼ë¡œ ì²´ì¤‘ì„ ëŠ˜ë¦¬ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.';
            } else if (bmi < 23) {
                result = 'ì •ìƒ';
                message = 'í˜„ì¬ ì²´ì¤‘ì„ ì˜ ìœ ì§€í•˜ê³  ê³„ì‹­ë‹ˆë‹¤! ê¾¸ì¤€íˆ ê±´ê°•ì„ ê´€ë¦¬í•´ì£¼ì„¸ìš”.';
            } else if (bmi < 25) {
                result = 'ê³¼ì²´ì¤‘';
                message = 'ì‹ë‹¨ ì¡°ì ˆê³¼ ê¾¸ì¤€í•œ ìš´ë™ì„ í†µí•´ ì²´ì¤‘ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.';
            } else {
                result = 'ë¹„ë§Œ';
                message = 'ê±´ê°•ì„ ìœ„í•´ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì—¬ ì²´ê³„ì ì¸ ì²´ì¤‘ ê°ëŸ‰ ê³„íšì„ ì„¸ìš°ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.';
            }

            return `
                <div class="p-3 mb-3 bg-light rounded">
                    <h5><i class="fas fa-balance-scale-right me-2"></i>BMI ë¶„ì„</h5>
                    <p>íšŒì›ë‹˜ì˜ BMI ì§€ìˆ˜ëŠ” <strong>${bmi}</strong>ë¡œ, <strong>${result}</strong> ë²”ìœ„ì— ì†í•©ë‹ˆë‹¤.</p>
                    <p class="mb-0"><em>${message}</em></p>
                </div>`;
        }

        // ì¹¼ë¡œë¦¬ ë¶„ì„ í•¨ìˆ˜
        function analyzeCalories(userData, stats, user) {
            if (userData.meals.length < 3) {
                return '<div class="alert alert-info">ì‹ë‹¨ ê¸°ë¡ì´ 3ê°œ ì´ìƒ ìŒ“ì´ë©´ ë” ì •í™•í•œ ì¹¼ë¡œë¦¬ ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
            }
            
            let totalCalories = 0;
            userData.meals.forEach(meal => meal.foods.forEach(food => totalCalories += food.calories));
            const avgCalories = Math.round(totalCalories / userData.meals.length);

            if (!user.age) {
                return '<div class="alert alert-warning">í”„ë¡œí•„ì— ë‚˜ì´ë¥¼ ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ ì¹¼ë¡œë¦¬ ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
            }
            const age = parseInt(user.age);
            let ageGroup = '19-29';
            if (age >= 30 && age <=39) ageGroup = '30-39';
            else if (age >= 40 && age <=49) ageGroup = '40-49';
            else if (age >= 50 && age <=59) ageGroup = '50-59';
            else if (age >= 60 && age <=69) ageGroup = '60-69';
            else if (age >= 70) ageGroup = '70+';

            const peerAvgCalories = stats.averageIntake.byAgeAndGender[ageGroup].total;
            let message;

            if (avgCalories > peerAvgCalories * 1.1) {
                message = `í˜„ì¬ í‰ê·  ì„­ì·¨ ì¹¼ë¡œë¦¬ëŠ” ì•½ <strong>${avgCalories}kcal</strong>ë¡œ, ì—°ë ¹ëŒ€ í‰ê· (${peerAvgCalories}kcal)ë³´ë‹¤ ë‹¤ì†Œ ë†’ì€ í¸ì…ë‹ˆë‹¤. ì¹¼ë¡œë¦¬ê°€ ë‚®ì€ ìŒì‹ ìœ„ì£¼ë¡œ ì‹ë‹¨ì„ êµ¬ì„±í•´ë³´ì„¸ìš”.`;
            } else if (avgCalories < peerAvgCalories * 0.9) {
                message = `í˜„ì¬ í‰ê·  ì„­ì·¨ ì¹¼ë¡œë¦¬ëŠ” ì•½ <strong>${avgCalories}kcal</strong>ë¡œ, ì—°ë ¹ëŒ€ í‰ê· (${peerAvgCalories}kcal)ë³´ë‹¤ ë‚®ì€ í¸ì…ë‹ˆë‹¤. ì¶©ë¶„í•œ ì—ë„ˆì§€ë¥¼ ìœ„í•´ ì„­ì·¨ëŸ‰ì„ ì¡°ê¸ˆ ëŠ˜ë¦¬ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`;
            } else {
                message = `í˜„ì¬ í‰ê·  ì„­ì·¨ ì¹¼ë¡œë¦¬ëŠ” ì•½ <strong>${avgCalories}kcal</strong>ë¡œ, ì—°ë ¹ëŒ€ í‰ê· (${peerAvgCalories}kcal)ê³¼ ë¹„ìŠ·í•œ ìˆ˜ì¤€ìœ¼ë¡œ ì˜ ê´€ë¦¬í•˜ê³  ê³„ì‹­ë‹ˆë‹¤.`;
            }

            return `
                <div class="p-3 mb-3 bg-light rounded">
                    <h5><i class="fas fa-fire-alt me-2"></i>ì¹¼ë¡œë¦¬ ì„­ì·¨ ë¶„ì„</h5>
                    <p>${message}</p>
                </div>`;
        }

        // ì‹ë‹¨ ë‹¤ì–‘ì„± ë¶„ì„ í•¨ìˆ˜
        function analyzeDietVariety(userData) {
            const foodCounter = {};
            let totalFoods = 0;
            userData.meals.forEach(meal => {
                meal.foods.forEach(food => {
                    foodCounter[food.name] = (foodCounter[food.name] || 0) + 1;
                    totalFoods++;
                });
            });

            const uniqueFoods = Object.keys(foodCounter).length;
            let message;

            if (totalFoods < 10) {
                return ''; // ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ ë¶„ì„ ìƒëµ
            }

            if (uniqueFoods / totalFoods < 0.5) {
                message = 'ìµœê·¼ ì‹ë‹¨ì´ ë‹¤ì†Œ ë‹¨ì¡°ë¡œìš´ ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ ìŒì‹ì„ ì„­ì·¨í•˜ì—¬ ê· í˜• ì¡íŒ ì˜ì–‘ì„ ì±™ê²¨ë³´ì„¸ìš”.';
            } else {
                message = 'ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ ìŒì‹ì„ ì„­ì·¨í•˜ë©° ì‹ë‹¨ì„ ì˜ ê´€ë¦¬í•˜ê³  ê³„ì‹­ë‹ˆë‹¤. ì¢‹ì€ ìŠµê´€ì…ë‹ˆë‹¤!';
            }

            return `
                <div class="p-3 bg-light rounded">
                    <h5><i class="fas fa-seedling me-2"></i>ì‹ë‹¨ ë‹¤ì–‘ì„± ë¶„ì„</h5>
                    <p>${message}</p>
                </div>`;
        }

    </script>
</body>
</html>