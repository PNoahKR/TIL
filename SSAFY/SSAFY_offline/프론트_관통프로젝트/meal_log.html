<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>냠냠코치 - 식단 기록하기</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">💪 냠냠코치</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">대시보드</a></li>
                    <li class="nav-item"><a class="nav-link active" href="meal_log.html">식단기록</a></li>
                    <li class="nav-item"><a class="nav-link" href="challenge.html">챌린지</a></li>
                    <li class="nav-item"><a class="nav-link" href="community.html">커뮤니티</a></li>
                    <li class="nav-item"><a class="nav-link" href="ai_coach.html">AI코치</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> 마이페이지
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">프로필 수정</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html">로그아웃</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 70px;">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h2 class="h4 mb-0">식단 기록하기</h2>
            </div>
            <div class="card-body">
              <form id="meal-log-form">
                <div class="mb-3">
                  <label for="mealDate" class="form-label">날짜</label>
                  <input type="date" class="form-control" id="mealDate" value="2025-09-05" />
                </div>
                <div class="mb-3">
                  <label for="mealTime" class="form-label">식사</label>
                  <select class="form-select" id="mealTime">
                    <option selected>아침</option>
                    <option>점심</option>
                    <option>저녁</option>
                    <option>간식</option>
                  </select>
                </div>

                <div class="mb-4 p-3 border rounded">
                  <label for="foodSearch" class="form-label fw-bold">음식 검색</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="foodSearch" placeholder="음식 이름을 검색하세요 (예: 닭가슴살)" />
                  </div>
                  <div id="search-results" class="list-group mt-2"></div>
                </div>

                <div class="mb-4">
                  <h4 class="h5">기록될 음식</h4>
                  <ul id="selected-food-list" class="list-group">
                    <!-- 선택된 음식이 여기에 추가됩니다. -->
                  </ul>
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary btn-lg">기록 저장하기</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-white text-center p-4 mt-5">
      <div class="container">
        <p class="mb-0">&copy; 2025 YumYumCoach. All Rights Reserved.</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dataManager.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const mealIdToEdit = urlParams.get('edit') ? Number(urlParams.get('edit')) : null;

      let foodDB = [];
      const searchInput = document.getElementById('foodSearch');
      const searchResultsContainer = document.getElementById('search-results');
      const selectedFoodList = document.getElementById('selected-food-list');
      const form = document.getElementById('meal-log-form');
      const pageTitle = document.querySelector('.card-header h2');
      const submitButton = form.querySelector('button[type="submit"]');

      // 페이지 로드 시 실행
      document.addEventListener('DOMContentLoaded', async () => {
        await loadFoodData();
        if (mealIdToEdit) {
            setupEditMode(mealIdToEdit);
        }
      });

      // 수정 모드 설정
      function setupEditMode(mealId) {
        const meals = getData('meals');
        const mealToEdit = meals.find(m => m.id === mealId);

        if (!mealToEdit) {
            alert('수정할 식단 정보를 찾을 수 없습니다.');
            window.location.href = 'dashboard.html';
            return;
        }

        pageTitle.textContent = '식단 수정하기';
        submitButton.textContent = '수정 저장하기';

        document.getElementById('mealDate').value = mealToEdit.date;
        document.getElementById('mealTime').value = mealToEdit.type;
        
        mealToEdit.foods.forEach(food => addFoodToSelectedList(food));
      }

      // 음식 데이터 로드
      async function loadFoodData() {
        try {
          const response = await fetch('./data/food_db.json');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          foodDB = await response.json();
        } catch (error) {
          console.error("음식 DB를 불러오는 데 실패했습니다:", error);
        }
      }

      // 검색 결과 표시
      function displaySearchResults(results) {
        searchResultsContainer.innerHTML = '';
        if (results.length === 0) {
          searchResultsContainer.style.display = 'none';
          return;
        }
        
        const resultItems = results.slice(0, 10).map(food => `
          <a href="#" class="list-group-item list-group-item-action" data-food-name="${food.name}">
            ${food.name} - ${food.calories} kcal
          </a>
        `).join('');
        
        searchResultsContainer.innerHTML = resultItems;
        searchResultsContainer.style.display = 'block';
      }

      // 선택된 음식 목록에 추가
      function addFoodToSelectedList(food) {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.dataset.food = JSON.stringify(food);
        listItem.innerHTML = `
          <div>
            <strong>${food.name}</strong>
            <small class="text-muted">(${Math.round(food.calories)} kcal, 단백질 ${Math.round(food.protein)}g, 탄수화물 ${Math.round(food.carbs)}g, 지방 ${Math.round(food.fat)}g)</small>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger remove-food-btn"><i class="fas fa-times"></i></button>
        `;
        selectedFoodList.appendChild(listItem);
      }

      // 검색 이벤트 리스너
      searchInput.addEventListener('keyup', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length < 2) {
          searchResultsContainer.innerHTML = '';
          searchResultsContainer.style.display = 'none';
          return;
        }
        const filteredFoods = foodDB.filter(food => food.name.toLowerCase().includes(searchTerm));
        displaySearchResults(filteredFoods);
      });

      // 검색 결과 클릭 이벤트 리스너
      searchResultsContainer.addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.matches('.list-group-item')) {
          const foodName = e.target.dataset.foodName;
          const selectedFood = foodDB.find(food => food.name === foodName);
          if (selectedFood) {
            addFoodToSelectedList(selectedFood);
            searchInput.value = '';
            searchResultsContainer.innerHTML = '';
            searchResultsContainer.style.display = 'none';
          }
        }
      });

      // 선택된 음식 제거 이벤트 리스너
      selectedFoodList.addEventListener('click', (e) => {
        if (e.target.closest('.remove-food-btn')) {
          e.target.closest('.list-group-item').remove();
        }
      });

      // 폼 제출
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const mealDate = document.getElementById('mealDate').value;
        const mealTime = document.getElementById('mealTime').value;
        const selectedFoods = [];
        
        selectedFoodList.querySelectorAll('.list-group-item').forEach(item => {
            selectedFoods.push(JSON.parse(item.dataset.food));
        });

        if (selectedFoods.length === 0) {
            alert('기록할 음식을 추가해주세요.');
            return;
        }

        const mealObject = {
            id: mealIdToEdit || Date.now(), // 수정 모드이면 기존 ID 사용
            date: mealDate,
            type: mealTime,
            foods: selectedFoods
        };

        if (mealIdToEdit) {
            // 수정 모드
            updateItem('meals', mealIdToEdit, mealObject);
            alert('식단이 성공적으로 수정되었습니다.');
        } else {
            // 생성 모드
            addItem('meals', mealObject);
            alert('식단이 성공적으로 기록되었습니다.');
        }

        window.location.href = 'dashboard.html';
      });
    </script>
  </body>
</html>
