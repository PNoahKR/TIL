<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëƒ ëƒ ì½”ì¹˜ - ì‹ë‹¨ ê¸°ë¡í•˜ê¸°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">ğŸ’ª ëƒ ëƒ ì½”ì¹˜</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
                    <li class="nav-item"><a class="nav-link active" href="meal_log.html">ì‹ë‹¨ê¸°ë¡</a></li>
                    <li class="nav-item"><a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a></li>
                    <li class="nav-item"><a class="nav-link" href="community.html">ì»¤ë®¤ë‹ˆí‹°</a></li>
                    <li class="nav-item"><a class="nav-link" href="ai_coach.html">AIì½”ì¹˜</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> ë§ˆì´í˜ì´ì§€
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">í”„ë¡œí•„ ìˆ˜ì •</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html">ë¡œê·¸ì•„ì›ƒ</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 70px;">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h2 class="h4 mb-0">ì‹ë‹¨ ê¸°ë¡í•˜ê¸°</h2>
            </div>
            <div class="card-body">
              <form id="meal-log-form">
                <div class="mb-3">
                  <label for="mealDate" class="form-label">ë‚ ì§œ</label>
                  <input type="date" class="form-control" id="mealDate" value="2025-09-05" />
                </div>
                <div class="mb-3">
                  <label for="mealTime" class="form-label">ì‹ì‚¬</label>
                  <select class="form-select" id="mealTime">
                    <option selected>ì•„ì¹¨</option>
                    <option>ì ì‹¬</option>
                    <option>ì €ë…</option>
                    <option>ê°„ì‹</option>
                  </select>
                </div>

                <div class="mb-4 p-3 border rounded">
                  <label for="foodSearch" class="form-label fw-bold">ìŒì‹ ê²€ìƒ‰</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="foodSearch" placeholder="ìŒì‹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš” (ì˜ˆ: ë‹­ê°€ìŠ´ì‚´)" />
                  </div>
                  <div id="search-results" class="list-group mt-2"></div>
                </div>

                <div class="mb-4">
                  <h4 class="h5">ê¸°ë¡ë  ìŒì‹</h4>
                  <ul id="selected-food-list" class="list-group">
                    <!-- ì„ íƒëœ ìŒì‹ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
                  </ul>
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary btn-lg">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-white text-center p-4 mt-5">
      <div class="container">
        <p class="mb-0">&copy; 2025 YumYumCoach. All Rights Reserved.</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dataManager.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const mealIdToEdit = urlParams.get('edit') ? Number(urlParams.get('edit')) : null;

      let foodDB = [];
      const searchInput = document.getElementById('foodSearch');
      const searchResultsContainer = document.getElementById('search-results');
      const selectedFoodList = document.getElementById('selected-food-list');
      const form = document.getElementById('meal-log-form');
      const pageTitle = document.querySelector('.card-header h2');
      const submitButton = form.querySelector('button[type="submit"]');

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener('DOMContentLoaded', async () => {
        await loadFoodData();
        if (mealIdToEdit) {
            setupEditMode(mealIdToEdit);
        }
      });

      // ìˆ˜ì • ëª¨ë“œ ì„¤ì •
      function setupEditMode(mealId) {
        const meals = getData('meals');
        const mealToEdit = meals.find(m => m.id === mealId);

        if (!mealToEdit) {
            alert('ìˆ˜ì •í•  ì‹ë‹¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = 'dashboard.html';
            return;
        }

        pageTitle.textContent = 'ì‹ë‹¨ ìˆ˜ì •í•˜ê¸°';
        submitButton.textContent = 'ìˆ˜ì • ì €ì¥í•˜ê¸°';

        document.getElementById('mealDate').value = mealToEdit.date;
        document.getElementById('mealTime').value = mealToEdit.type;
        
        mealToEdit.foods.forEach(food => addFoodToSelectedList(food));
      }

      // ìŒì‹ ë°ì´í„° ë¡œë“œ
      async function loadFoodData() {
        try {
          const response = await fetch('./data/food_db.json');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          foodDB = await response.json();
        } catch (error) {
          console.error("ìŒì‹ DBë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
        }
      }

      // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
      function displaySearchResults(results) {
        searchResultsContainer.innerHTML = '';
        if (results.length === 0) {
          searchResultsContainer.style.display = 'none';
          return;
        }
        
        const resultItems = results.slice(0, 10).map(food => `
          <a href="#" class="list-group-item list-group-item-action" data-food-name="${food.name}">
            ${food.name} - ${food.calories} kcal
          </a>
        `).join('');
        
        searchResultsContainer.innerHTML = resultItems;
        searchResultsContainer.style.display = 'block';
      }

      // ì„ íƒëœ ìŒì‹ ëª©ë¡ì— ì¶”ê°€
      function addFoodToSelectedList(food) {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.dataset.food = JSON.stringify(food);
        listItem.innerHTML = `
          <div>
            <strong>${food.name}</strong>
            <small class="text-muted">(${Math.round(food.calories)} kcal, ë‹¨ë°±ì§ˆ ${Math.round(food.protein)}g, íƒ„ìˆ˜í™”ë¬¼ ${Math.round(food.carbs)}g, ì§€ë°© ${Math.round(food.fat)}g)</small>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger remove-food-btn"><i class="fas fa-times"></i></button>
        `;
        selectedFoodList.appendChild(listItem);
      }

      // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      searchInput.addEventListener('keyup', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length < 2) {
          searchResultsContainer.innerHTML = '';
          searchResultsContainer.style.display = 'none';
          return;
        }
        const filteredFoods = foodDB.filter(food => food.name.toLowerCase().includes(searchTerm));
        displaySearchResults(filteredFoods);
      });

      // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      searchResultsContainer.addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.matches('.list-group-item')) {
          const foodName = e.target.dataset.foodName;
          const selectedFood = foodDB.find(food => food.name === foodName);
          if (selectedFood) {
            addFoodToSelectedList(selectedFood);
            searchInput.value = '';
            searchResultsContainer.innerHTML = '';
            searchResultsContainer.style.display = 'none';
          }
        }
      });

      // ì„ íƒëœ ìŒì‹ ì œê±° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      selectedFoodList.addEventListener('click', (e) => {
        if (e.target.closest('.remove-food-btn')) {
          e.target.closest('.list-group-item').remove();
        }
      });

      // í¼ ì œì¶œ
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const mealDate = document.getElementById('mealDate').value;
        const mealTime = document.getElementById('mealTime').value;
        const selectedFoods = [];
        
        selectedFoodList.querySelectorAll('.list-group-item').forEach(item => {
            selectedFoods.push(JSON.parse(item.dataset.food));
        });

        if (selectedFoods.length === 0) {
            alert('ê¸°ë¡í•  ìŒì‹ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
            return;
        }

        const mealObject = {
            id: mealIdToEdit || Date.now(), // ìˆ˜ì • ëª¨ë“œì´ë©´ ê¸°ì¡´ ID ì‚¬ìš©
            date: mealDate,
            type: mealTime,
            foods: selectedFoods
        };

        if (mealIdToEdit) {
            // ìˆ˜ì • ëª¨ë“œ
            updateItem('meals', mealIdToEdit, mealObject);
            alert('ì‹ë‹¨ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            // ìƒì„± ëª¨ë“œ
            addItem('meals', mealObject);
            alert('ì‹ë‹¨ì´ ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        window.location.href = 'dashboard.html';
      });
    </script>
  </body>
</html>
