<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëƒ ëƒ ì½”ì¹˜ - ëŒ€ì‹œë³´ë“œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">ğŸ’ª ëƒ ëƒ ì½”ì¹˜</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
                    <li class="nav-item"><a class="nav-link" href="meal_log.html">ì‹ë‹¨ê¸°ë¡</a></li>
                    <li class="nav-item"><a class="nav-link" href="challenge.html">ì±Œë¦°ì§€</a></li>
                    <li class="nav-item"><a class="nav-link" href="community.html">ì»¤ë®¤ë‹ˆí‹°</a></li>
                    <li class="nav-item"><a class="nav-link" href="ai_coach.html">AIì½”ì¹˜</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> ë§ˆì´í˜ì´ì§€
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">í”„ë¡œí•„ ìˆ˜ì •</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html">ë¡œê·¸ì•„ì›ƒ</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 70px;">
      <section class="mb-5 scroll-content">
        <h2 class="mb-3 border-bottom pb-2">ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ìƒì„¸</h2>
        <div class="row g-4">
          <div class="col-md-3">
            <div class="card text-center h-100 shadow-sm">
              <div class="card-body">
                <h5 class="card-title">ëª©í‘œ ì¹¼ë¡œë¦¬</h5>
                <p class="fs-2 text-success fw-bold">
                  <span id="goal-calories">2000</span>
                  <span class="fs-6 text-muted">kcal</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center h-100 shadow-sm">
              <div class="card-body">
                <h5 class="card-title">ì„­ì·¨ ì¹¼ë¡œë¦¬</h5>
                <p class="fs-2 text-success fw-bold">
                  <span id="consumed-calories">0</span>
                  <span class="fs-6 text-muted">kcal</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-3">ì˜ì–‘ì†Œ ì„­ì·¨ í˜„í™©</h5>
                <div>
                  <label class="form-label">ë‹¨ë°±ì§ˆ</label>
                  <div class="progress" style="height: 20px">
                    <div id="protein-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%">0g / 100g</div>
                  </div>
                </div>
                <div class="mt-2">
                  <label class="form-label">íƒ„ìˆ˜í™”ë¬¼</label>
                  <div class="progress" style="height: 20px">
                    <div id="carbs-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%">0g / 100g</div>
                  </div>
                </div>
                <div class="mt-2">
                  <label class="form-label">ì§€ë°©</label>
                  <div class="progress" style="height: 20px">
                    <div id="fat-progress" class="progress-bar bg-danger" role="progressbar" style="width: 0%">0g / 100g</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="mb-5 scroll-content">
        <h2 class="mb-3 border-bottom pb-2">ì£¼ê°„ ì„­ì·¨ëŸ‰ ë¶„ì„</h2>
        <div class="card shadow-sm">
          <div class="card-body">
            <canvas id="weeklyNutritionChart"></canvas>
          </div>
        </div>
      </section>

      <section class="scroll-content">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
          <h2>ìµœê·¼ ì‹ë‹¨ ê¸°ë¡</h2>
          <a href="meal_log.html" class="btn btn-success">
            <i class="fas fa-plus me-1"></i>
            ì‹ë‹¨ ê¸°ë¡í•˜ê¸°
          </a>
        </div>
        <div class="list-group shadow-sm" id="meal-list-container">
          <!-- ìµœê·¼ ì‹ë‹¨ ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
        </div>
      </section>
    </main>

    <footer class="bg-dark text-white text-center p-4 mt-5">
      <div class="container">
        <p class="mb-0">&copy; 2025 YumYumCoach. All Rights Reserved.</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dataManager.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("visible");
              }
            });
          },
          {
            threshold: 0.1, // 10% ë³´ì˜€ì„ ë•Œ ì‹¤í–‰
          }
        );

        const scrollContent = document.querySelectorAll(".scroll-content");
        scrollContent.forEach((content) => {
          observer.observe(content);
        });
      });
    </script>
    <script>
        const TODAY = new Date().toISOString().split('T')[0];

        // ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ í•¨ìˆ˜
        function loadDashboardData() {
            const userData = getUserData();
            if (!userData) return;

            // 1. ì˜¤ëŠ˜ì˜ ì„­ì·¨ í˜„í™© ì—…ë°ì´íŠ¸
            updateTodaySummary(userData.meals, userData.goals);

            // 2. ìµœê·¼ ì‹ë‹¨ ê¸°ë¡ ëª©ë¡ ìƒì„±
            renderMealList(userData.meals);

            // 3. ì£¼ê°„ ì„­ì·¨ëŸ‰ ì°¨íŠ¸ ìƒì„±
            renderWeeklyChart(userData.meals);
        }

        function updateTodaySummary(meals, goals) {
            const todayMeals = meals.filter(meal => meal.date === TODAY);
            
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
            
            todayMeals.forEach(meal => {
                meal.foods.forEach(food => {
                    totalCalories += food.calories;
                    totalProtein += food.protein;
                    totalCarbs += food.carbs;
                    totalFat += food.fat;
                });
            });

            // í™”ë©´ ìš”ì†Œ ì—…ë°ì´íŠ¸
            document.querySelector('#goal-calories').textContent = goals.dailyCalories;
            document.querySelector('#consumed-calories').textContent = Math.round(totalCalories);

            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            updateProgressBar('#protein-progress', totalProtein, goals.protein);
            updateProgressBar('#carbs-progress', totalCarbs, goals.carbs);
            updateProgressBar('#fat-progress', totalFat, goals.fat);
        }

        function updateProgressBar(selector, current, goal) {
            const percentage = goal > 0 ? Math.min((current / goal) * 100, 100) : 0;
            const progressBar = document.querySelector(selector);
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${Math.round(current)}g / ${goal}g`;
        }

        function renderMealList(meals) {
            const mealListContainer = document.querySelector('#meal-list-container');
            mealListContainer.innerHTML = ''; 

            if(meals.length === 0){
                mealListContainer.innerHTML = '<p class="text-center text-muted">ì•„ì§ ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ìµœì‹  ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ í›„, ìƒìœ„ 5ê°œë§Œ ì„ íƒ
            const sortedMeals = meals.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            sortedMeals.forEach(meal => {
                const foodsHtml = meal.foods.map(food => food.name).join(', ');
                const totalNutrients = meal.foods.reduce((acc, food) => {
                    acc.calories += food.calories;
                    acc.protein += food.protein;
                    acc.carbs += food.carbs;
                    acc.fat += food.fat;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

                const mealHtml = `
                    <div class="list-group-item list-group-item-action" data-meal-id="${meal.id}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${meal.date} (${meal.type})</h5>
                        </div>
                        <p class="mb-1">${foodsHtml}</p>
                        <small class="text-muted">
                            ì¹¼ë¡œë¦¬: ${Math.round(totalNutrients.calories)}kcal | ë‹¨ë°±ì§ˆ: ${Math.round(totalNutrients.protein)}g | íƒ„ìˆ˜í™”ë¬¼: ${Math.round(totalNutrients.carbs)}g | ì§€ë°©: ${Math.round(totalNutrients.fat)}g
                        </small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary edit-btn">ìˆ˜ì •</button>
                            <button class="btn btn-sm btn-outline-danger delete-btn">ì‚­ì œ</button>
                        </div>
                    </div>`;
                mealListContainer.innerHTML += mealHtml;
            });
        }

        let weeklyChart = null;
        function renderWeeklyChart(meals) {
            const ctx = document.getElementById('weeklyNutritionChart').getContext('2d');
            if(weeklyChart) {
                weeklyChart.destroy();
            }
            
            // ìµœê·¼ 7ì¼ê°„ì˜ ë°ì´í„° ì§‘ê³„
            const weeklyData = {};
            const today = new Date(TODAY);

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                weeklyData[dateString] = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            }

            meals.forEach(meal => {
                if (weeklyData.hasOwnProperty(meal.date)) {
                    meal.foods.forEach(food => {
                        weeklyData[meal.date].calories += food.calories;
                        weeklyData[meal.date].protein += food.protein;
                        weeklyData[meal.date].carbs += food.carbs;
                        weeklyData[meal.date].fat += food.fat;
                    });
                }
            });

            const labels = Object.keys(weeklyData);
            const calorieData = labels.map(date => weeklyData[date].calories);
            const proteinData = labels.map(date => weeklyData[date].protein);
            const carbsData = labels.map(date => weeklyData[date].carbs);
            const fatData = labels.map(date => weeklyData[date].fat);

            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => new Date(l).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })),
                    datasets: [{
                        label: 'ì¹¼ë¡œë¦¬ (kcal)',
                        data: calorieData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        yAxisID: 'y-axis-calories'
                    }, {
                        label: 'ë‹¨ë°±ì§ˆ (g)',
                        data: proteinData,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        yAxisID: 'y-axis-nutrients'
                    }, {
                        label: 'íƒ„ìˆ˜í™”ë¬¼ (g)',
                        data: carbsData,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        fill: false,
                        yAxisID: 'y-axis-nutrients'
                    }, {
                        label: 'ì§€ë°© (g)',
                        data: fatData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false,
                        yAxisID: 'y-axis-nutrients'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        'y-axis-calories': {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ì¹¼ë¡œë¦¬ (kcal)'
                            }
                        },
                        'y-axis-nutrients': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ì˜ì–‘ì†Œ (g)'
                            },
                            grid: {
                                drawOnChartArea: false // only want the grid lines for one axis to show up
                            }
                        }
                    }
                }
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë”© í•¨ìˆ˜ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', loadDashboardData);

        // ì‹ë‹¨ ëª©ë¡ì˜ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('meal-list-container').addEventListener('click', function(e) {
            const target = e.target;
            const mealItem = target.closest('.list-group-item');
            if (!mealItem) return;

            const mealId = Number(mealItem.dataset.mealId);

            if (target.classList.contains('delete-btn')) {
                if (confirm('ì´ ì‹ë‹¨ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    deleteItem('meals', mealId);
                    loadDashboardData(); // ë°ì´í„° ì‚­ì œ í›„ ëŒ€ì‹œë³´ë“œ ë‹¤ì‹œ ë Œë”ë§
                }
            }
            if (target.classList.contains('edit-btn')) {
                window.location.href = `meal_log.html?edit=${mealId}`;
            }
        });
    </script>
</body>
</html>
